@page "/"

@using System.Net.Http
@using System.Text.Json
@using System.Linq

<PageTitle>Home</PageTitle>

<h1>Showing search results for: "dog"</h1>

<!--Place videos in grid format-->
<div class="videos-grid">
    @foreach (var video in CurrentPageVideos)
    {
        <!--Display thumbnail, title, and channel name-->
        <div class="video-item">
            <img src="@video.ThumbnailUrl" alt="@video.Title" />
            <div class="video-details">
                <h2>@video.Title</h2>
                <p>@video.ChannelTitle</p>
            </div>
        </div>
    }
</div>

<!--Create buttons to navigate through pages-->
<button disabled="@IsFirstPage" @onclick="LoadPreviousPage">Previous</button>
<button disabled="@IsLastPage" @onclick="LoadNextPage">Next</button>

@code {
    private List<YouTubeVideo> videos = new List<YouTubeVideo>();
    private List<YouTubeVideo> CurrentPageVideos = new List<YouTubeVideo>();
    private string nextPageToken;
    private string prevPageToken;
    private int maxResultsPerPage = 10;
    private int currentPageIndex = 0;

    private bool IsFirstPage => string.IsNullOrEmpty(prevPageToken);
    private bool IsLastPage => string.IsNullOrEmpty(nextPageToken);

    protected override async Task OnInitializedAsync()
    {
        await LoadVideos();
        UpdateCurrentPageVideos();
    }

    // Load videos using api key and search query
    private async Task LoadVideos(string pageToken = null)
    {
        HttpClient httpClient = new HttpClient();
        var apiKey = "AIzaSyBdZbxljpt7Yh014oeoXenbOi7-SgiPJQk";
        var searchQuery = "dog";
        var maxResults = 20; // Set a large value for maxResults to ensure a significant number of results
        var order = "relevance"; // Set order
        var url = $"https://www.googleapis.com/youtube/v3/search?key={apiKey}&q={searchQuery}&part=snippet&type=video&maxResults={maxResults}&order={order}";

        if (!string.IsNullOrEmpty(pageToken))
        {
            url += $"&pageToken={pageToken}";
        }

        var response = await httpClient.GetAsync(url);
        var content = await response.Content.ReadAsStringAsync();
        var result = JsonSerializer.Deserialize<YouTubeSearchResponse>(content);

        // Add newly retrieved videos to the existing list
        videos.AddRange(result.items.Select(item => new YouTubeVideo
            {
                Title = item.snippet.title,
                ThumbnailUrl = item.snippet.thumbnails.@default.url,
                ChannelTitle = item.snippet.channelTitle
            }));

        nextPageToken = result.nextPageToken;
        prevPageToken = result.prevPageToken;
    }

    // Load current page of videos to display
    private void UpdateCurrentPageVideos()
    {
        CurrentPageVideos = videos.Skip(currentPageIndex * maxResultsPerPage)
                                  .Take(maxResultsPerPage)
                                  .ToList();
    }

    // Load next page of videos
    private async Task LoadNextPage()
    {
        if (!string.IsNullOrEmpty(nextPageToken))
        {
            currentPageIndex++;
            await LoadVideos(nextPageToken); // Load videos for the next page
            UpdateCurrentPageVideos();
        }
    }

    // Load previous page of videos
    private async Task LoadPreviousPage()
    {
        if (!string.IsNullOrEmpty(prevPageToken))
        {
            currentPageIndex--;
            // No need to reload videos from API, just update the current page
            UpdateCurrentPageVideos();
        }
    }

    public class YouTubeVideo
    {
        public string Title { get; set; }
        public string ThumbnailUrl { get; set; }
        public string ChannelTitle { get; set; }
    }

    public class YouTubeSearchResponse
    {
        public List<YouTubeVideoItem> items { get; set; }
        public string nextPageToken { get; set; }
        public string prevPageToken { get; set; }
    }

    public class YouTubeVideoItem
    {
        public YouTubeVideoSnippet snippet { get; set; }
    }

    public class YouTubeVideoSnippet
    {
        public string title { get; set; }
        public string channelTitle { get; set; }
        public YouTubeThumbnail thumbnails { get; set; }
    }

    public class YouTubeThumbnail
    {
        public YouTubeThumbnailDetails @default { get; set; }
    }

    public class YouTubeThumbnailDetails
    {
        public string url { get; set; }
    }
}